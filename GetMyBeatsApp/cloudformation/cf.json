{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"description to be determined...",
    "Parameters": {
        "AccessKey": {
            "Type": "String",
            "Description": "aws access key"
        },
        "SecretAccessKey": {
            "Type": "String",
            "Description": "aws secret access key"
        },
        "SSHKey": {
            "Type": "AWS::EC2::KeyPair::KeyName",
            "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
            "ConstraintDescription": "must be the name of an existing EC2 KeyPair"
        },
        "DbSettings": {
            "Type": "String",
            "Description": "database settings"
        },
        "CodeVersion": {
            "Type": "String",
            "Description": "git commit for software versioning"
        },
        "DjangoSecretKey": {
            "Type": "String",
            "Description": "Django secret key"
        }
    },
    "Resources":{
        "WebServerSecurityGroup" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" : {
              "GroupDescription" : "Enable HTTPS access via port 443",
              "SecurityGroupIngress" : [
                {"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0"},
                {"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0"},
                {"IpProtocol" : "tcp", "FromPort" : "443", "ToPort" : "443", "CidrIp" : "0.0.0.0/0"}
              ]
            }      
        },
        "getmybeatsapi":{
            "Type":"AWS::EC2::Instance",
            "Properties": {
                "Tags": [
                    {"Key": "Name", "Value": "getmybeatsapi"}
                ],
                "ImageId": "ami-0edab8d70528476d3",
                "SecurityGroups": [{"Ref": "WebServerSecurityGroup"}],
                "InstanceType": "t2.micro",
                "KeyName": {"Ref": "SSHKey"},
                "UserData"       : { "Fn::Base64" : { "Fn::Join" : ["", [
                    "#!/bin/bash -xe\n",
                    "yum update -y\n",
                    "yum install -y python-setuptools python3-pip wget npm nginx git setools net-tools\n",
                    "dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm\n",
                    "dnf install -y certbot python3-certbot-nginx supervisor\n",
                    "wget https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-py3-latest.tar.gz\n",
                    "pip3 install --upgrade pip\n",
                    "pip3 install awscli virtualenv\n",
                    "setenforce 1\n",
                    "semanage permissive -a httpd_t\n",
                    "setsebool -P httpd_can_network_connect 1\n",
                    "cd /var/log && mkdir django\n",
                    "cd /\n",
                    "mkdir application\n",
                    "cd /application && mkdir media && mkdir getmybeats\n",
                    "sudo mkdir /opt/aws\n",
                    "cd /opt/aws\n",
                    "pip3 install --ignore-installed --target=/opt/aws/ /aws-cfn-bootstrap-py3-latest.tar.gz\n",
                    "ln -s /opt/aws/cfnbootstrap /usr/lib/python3.9/site-packages/cfnbootstrap\n",
                    "/opt/aws/bin/cfn-init",
                    "         --stack ", { "Ref" : "AWS::StackName" },
                    "         --resource getmybeatsapi ",
                    "         --configsets Install ",
                    "         --region ", { "Ref" : "AWS::Region" }, "\n",
                    
                    "# Signal the status from cfn-init\n",
                    "/opt/aws/bin/cfn-signal -e $? ",
                    "         --stack ", { "Ref" : "AWS::StackName" },
                    "         --resource getmybeatsapi ",
                    "         --region ", { "Ref" : "AWS::Region" }, "\n"
               ]]}}
            },
            "Metadata":{
                "AWS::CloudFormation::Init":{
                    "configSets":{
                        "Install":["Install"]
                    },
                    "Install": {
                        "files": {
                            "/root/.ssh/config": {
                                "content" : { "Fn::Join" : ["", [
                                    "Host github.com\n",
                                    "   HostName github.com\n",
                                    "   User git\n",
                                    "   StrictHostKeyChecking no\n"
                                  ]]},
                                  "mode"    : "000700",
                                  "owner"   : "root",
                                  "group"   : "root"
                            },
                            "/root/.aws/credentials": {
                                "content" : { "Fn::Join" : ["", [
                                    "[default]\n",
                                    "aws_access_key_id=", { "Ref" : "AccessKey" }, "\n",
                                    "aws_secret_access_key=", { "Ref" : "SecretAccessKey" }, "\n",
                                    "region=us-west-2\n",
                                    "output=json\n"
                                  ]]},
                                  "mode"    : "000400",
                                  "owner"   : "root",
                                  "group"   : "root"
                            },
                            "/etc/environment": {
                               "content" : { "Fn::Join" : ["", [
                                  "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n",
                                  "DATABASE_SETTINGS=", { "Ref" : "DbSettings" }, "\n",
                                  "AWS_ACCESS_KEY=", { "Ref" : "AccessKey" }, "\n",
                                  "AWS_SECRET_ACCESS_KEY=", { "Ref" : "SecretAccessKey" }, "\n",
                                  "CODE_VERSION=", { "Ref" : "CodeVersion" }, "\n",
                                  "DJANGO_SECRET_KEY=", { "Ref" : "DjangoSecretKey" }, "\n"
                                ]]},
                                "mode"    : "000400",
                                "owner"   : "root",
                                "group"   : "root"
                            },
                            "/etc/cfn/cfn-hup.conf" : {
                                "content" : { "Fn::Join" : ["", [
                                  "[main]\n",
                                  "stack=", { "Ref" : "AWS::StackId" }, "\n",
                                  "region=", { "Ref" : "AWS::Region" }, "\n"
                                ]]},
                                "mode"    : "000400",
                                "owner"   : "root",
                                "group"   : "root"
                            },
                            "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : {
                                "content": { "Fn::Join" : ["", [
                                    "[cfn-auto-reloader-hook]\n",
                                    "triggers=post.update\n",
                                    "path=Resources.getmybeatsapi.Metadata.AWS::CloudFormation::Init\n",
                                    "action=/opt/aws/bin/cfn-init -v ",
                                    "         --stack ", { "Ref" : "AWS::StackName" },
                                    "         --resource getmybeatsapi ",
                                    "         --configsets Install ",
                                    "         --region ", { "Ref" : "AWS::Region" }, "\n",
                                    "runas=root\n"
                                ]]},
                                "mode"    : "000400",
                                "owner"   : "root",
                                "group"   : "root"
                            },
                            "/application/gunicorn_config.py": {
                                "content": { "Fn::Join" : ["", [
                                    "command = '/usr/local/bin/gunicorn'\n",
                                    "pythonpath = '/application/getmybeats'\n",
                                    "workers = 3\n",
                                    "bind = '127.0.0.1:8000'\n"

                                ]]},
                                "mode"    : "000400",
                                "owner"   : "root",
                                "group"   : "root"
                            }
                        },
                        "commands": {
                            "1-aws-sync" : {
                                "command" : "aws s3 sync s3://git-auth/ .ssh/ && sudo chmod 700 /root/.ssh/*",
                                "cwd": "~"
                            },
                            "2-create-venv": {
                                "command" : "cd /application && virtualenv getmybeatsvenv",
                                "cwd": "~"
                            },
                            "3-install-SSL-certificate-files": {
                                "command": "cd /etc && aws s3 cp s3://ssl-certificate-files/getmybeats-ssl-letsencrypt/letsencrypt.tar.gz letsencrypt.tar.gz && tar xvf letsencrypt.tar.gz",
                                "cwd": "~"
                            },
                            "4-install-nginx-config-file": {
                                "command": "cd /etc/nginx && aws s3 cp s3://ssl-certificate-files/getmybeats-ssl-letsencrypt/nginx.conf nginx.conf",
                                "cwd": "~"
                            },
                            "5-provision-applications": {
                                "command": "cd /application && aws s3 cp s3://getmybeats-provisioning/provisioning.sh provisioning.sh && sh provisioning.sh",
                                "cwd": "~"
                            }
                        },
                        "services": {
                            "systemd": {
                                "nginx": {
                                    "enabled": "true",
                                    "ensureRunning": "true"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}