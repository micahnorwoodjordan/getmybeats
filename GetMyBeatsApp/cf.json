{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"description to be determined...",
    "Parameters": {
        "AccessKey": {
            "Type": "String",
            "Description": "aws access key"
        },
        "SecretAccessKey": {
            "Type": "String",
            "Description": "aws secret access key"
        },
        "SSHKey": {
            "Type": "AWS::EC2::KeyPair::KeyName",
            "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
            "ConstraintDescription": "must be the name of an existing EC2 KeyPair"
        },
        "DbSettings": {
            "Type": "String",
            "Description": "database settings"
        },
        "GitCommitHash": {
            "Type": "String",
            "Description": "git commit for software versioning"
        }
    },
    "Resources":{
        "WebServerSecurityGroup" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" : {
              "GroupDescription" : "Enable HTTP access via port 80",
              "SecurityGroupIngress" : [
                {"IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0"},
                {"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0"}
              ]
            }      
        },
        "getmybeatsapi":{
            "Type":"AWS::EC2::Instance",
            "Properties": {
                "Tags": [
                    {"Key": "Name", "Value": "getmybeatsapi"}
                ],
                "ImageId": "ami-0edab8d70528476d3",
                "SecurityGroups": [{"Ref": "WebServerSecurityGroup"}],
                "InstanceType": "t2.small",
                "KeyName": {"Ref": "SSHKey"},
                "UserData"       : { "Fn::Base64" : { "Fn::Join" : ["", [
                    "#!/bin/bash -xe\n",
                    "yum update -y\n",
                    "yum install -y python-setuptools python3-pip wget nginx git setools\n",
                    "dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm\n",
                    "wget https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-py3-latest.tar.gz\n",
                    "pip3 install --upgrade pip\n",
                    "pip3 install awscli virtualenv\n",
                    "setenforce 1\n",
                    "semanage permissive -a httpd_t\n",
                    "setsebool -P httpd_can_network_connect 1\n",
                    "mkdir application\n",
                    "sudo mkdir /opt/aws\n",
                    "cd /opt/aws\n",
                    "pip3 install --ignore-installed --target=/opt/aws/ /aws-cfn-bootstrap-py3-latest.tar.gz\n",
                    "ln -s /opt/aws/cfnbootstrap /usr/lib/python3.9/site-packages/cfnbootstrap\n",
                    "/opt/aws/bin/cfn-init",
                    "         --stack ", { "Ref" : "AWS::StackName" },
                    "         --resource getmybeatsapi ",
                    "         --configsets Install ",
                    "         --region ", { "Ref" : "AWS::Region" }, "\n",
                    
                    "# Signal the status from cfn-init\n",
                    "/opt/aws/bin/cfn-signal -e $? ",
                    "         --stack ", { "Ref" : "AWS::StackName" },
                    "         --resource getmybeatsapi ",
                    "         --region ", { "Ref" : "AWS::Region" }, "\n"
               ]]}}
            },
            "Metadata":{
                "AWS::CloudFormation::Init":{
                    "configSets":{
                        "Install":["Install"]
                    },
                    "Install": {
                        "files": {
                            "/root/.ssh/config": {
                                "content" : { "Fn::Join" : ["", [
                                    "Host github.com\n",
                                    "   HostName github.com\n",
                                    "   User git\n",
                                    "   StrictHostKeyChecking no\n"
                                  ]]},
                                  "mode"    : "000700",
                                  "owner"   : "root",
                                  "group"   : "root"
                            },
                            "/root/.aws/credentials": {
                                "content" : { "Fn::Join" : ["", [
                                    "[default]\n",
                                    "aws_access_key_id=", { "Ref" : "AccessKey" }, "\n",
                                    "aws_secret_access_key=", { "Ref" : "SecretAccessKey" }, "\n",
                                    "region=us-west-2\n",
                                    "output=json\n"
                                  ]]},
                                  "mode"    : "000400",
                                  "owner"   : "root",
                                  "group"   : "root"
                            },
                            "/etc/environment": {
                               "content" : { "Fn::Join" : ["", [
                                  "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n",
                                  "DATABASE_SETTINGS=", { "Ref" : "DbSettings" }, "\n",
                                  "AWS_ACCESS_KEY=", { "Ref" : "AccessKey" }, "\n",
                                  "AWS_SECRET_ACCESS_KEY=", { "Ref" : "SecretAccessKey" }, "\n",
                                  "GIT_COMMIT_HASH=", { "Ref" : "GitCommitHash" }, "\n"
                                ]]},
                                "mode"    : "000400",
                                "owner"   : "root",
                                "group"   : "root"
                            },
                            "/etc/cfn/cfn-hup.conf" : {
                                "content" : { "Fn::Join" : ["", [
                                  "[main]\n",
                                  "stack=", { "Ref" : "AWS::StackId" }, "\n",
                                  "region=", { "Ref" : "AWS::Region" }, "\n"
                                ]]},
                                "mode"    : "000400",
                                "owner"   : "root",
                                "group"   : "root"
                            },
                            "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : {
                                "content": { "Fn::Join" : ["", [
                                    "[cfn-auto-reloader-hook]\n",
                                    "triggers=post.update\n",
                                    "path=Resources.getmybeatsapi.Metadata.AWS::CloudFormation::Init\n",
                                    "action=/opt/aws/bin/cfn-init -v ",
                                    "         --stack ", { "Ref" : "AWS::StackName" },
                                    "         --resource getmybeatsapi ",
                                    "         --configsets Install ",
                                    "         --region ", { "Ref" : "AWS::Region" }, "\n",
                                    "runas=root\n"
                                ]]},
                                "mode"    : "000400",
                                "owner"   : "root",
                                "group"   : "root"
                            },
                            "/etc/nginx/nginx.conf": {
                                "content": { "Fn::Join" : ["", [
                                    "events {\n",
                                    "\n",
                                    "}\n",
                                    "http {\n",
                                    "   include /etc/nginx/mime.types;\n",
                                    "   sendfile on;\n",
                                    "   server {\n",
                                    "       client_max_body_size 60M;\n",
                                    "       listen 80;\n",
                                    "       server_name getmybeats.com;\n",
                                    "       location /static {\n",
                                    "           root /application/getmybeats/;\n",
                                    "       }\n",
                                    "       location / {\n",
                                    "            proxy_pass http://127.0.0.1:8000/;\n",
                                    "            proxy_set_header Host $host;\n",
                                    "       }\n",
                                    "   }\n",
                                    "}\n"
                                ]]},
                                "mode"    : "000400",
                                "owner"   : "root",
                                "group"   : "root"
                            },
                            "/application/gunicorn_config.py": {
                                "content": { "Fn::Join" : ["", [
                                    "command = '/usr/local/bin/gunicorn'\n",
                                    "pythonpath = '/application/getmybeats'\n",
                                    "workers = 3\n",
                                    "bind = '127.0.0.1:8000'\n"

                                ]]},
                                "mode"    : "000400",
                                "owner"   : "root",
                                "group"   : "root"
                            }
                        },
                        "commands": {
                            "1-aws-sync" : {
                                "command" : "aws s3 sync s3://git-auth/ .ssh/ && sudo chmod 700 /root/.ssh/*",
                                "cwd": "~",
                                "ignoreErrors": true
                            },
                            "2-download-software" : {
                                "command" : " cd /application && git clone git@github.com:micahnorwoodjordan/getmybeats.git",
                                "cwd": "~",
                                "ignoreErrors": true
                            },
                            "3-checkout-software" : {
                                "command" : " cd /application/getmybeats && git checkout master",
                                "cwd": "~",
                                "ignoreErrors": true
                            },
                            "4-create-venv": {
                                "command" : "cd /application && virtualenv getmybeatsvenv",
                                "cwd": "~",
                                "ignoreErrors": true
                            },
                            "5-install-dependencies" : {
                                "command" : " cd /application/getmybeats && source ../getmybeatsvenv/bin/activate && pip3 install -r requirements.txt && cp /application/getmybeatsvenv/bin/gunicorn /usr/local/bin",
                                "cwd": "~",
                                "ignoreErrors": true
                            },
                            "6-django-mysql-hack" : {
                                "command" : "cd /application/getmybeats && echo 'import pymysql' >> GetMyBeatsSettings/__init__.py && echo 'pymysql.install_as_MySQLdb()' >> GetMyBeatsSettings/__init__.py",
                                "cwd": "~",
                                "ignoreErrors": true
                            },
                            "7-collectstatic": {
                                "command" : "cd /application/getmybeats && source ../getmybeatsvenv/bin/activate && ./manage.py collectstatic",
                                "cwd": "~",
                                "ignoreErrors": true
                            },
                            "start-gunicorn": {
                                "command": "cd /application/getmybeats && gunicorn -c ../gunicorn_config.py GetMyBeatsSettings.wsgi --daemon",
                                "cwd": "~",
                                "ignoreErrors": true
                            }
                        },
                        "services": {
                            "systemd": {
                                "nginx": {
                                    "enabled": "true",
                                    "ensureRunning": "true"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}